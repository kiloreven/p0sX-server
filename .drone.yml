build:
    image: kradalby/ci-tox:latest
    pull: true
    environment:
      - DJANGO_SETTINGS_MODULE=init_django.settings.prod
    commands:
      - tox

notify:
  email:
    from: drone@fap.no
    host: smtp.stud.ntnu.no
    port: 25
    recipients:
      - kradalby@kradalby.no

deploy:
  ssh:
    host: onyx.fap.no
    user: www
    port: 22
    when:
        branch: master
    commands:
      - cd /usr/local/www/p0sx.fap.no
      - git pull
      - export DJANGO_SETTINGS_MODULE=p0sx.settings.prod
      - make env
      - make prod
      - make migrate
      - make collect_static
      - supervisorctl restart uwsgi_p0sx.fap.no
